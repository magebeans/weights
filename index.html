<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Workout Resistance Tracker</title>
  <!-- Load Supabase UMD build for global `supabase` -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <style>
    /* Base & Theming */
    body {
      font-family: sans-serif;
      padding: 1rem;
      max-width: 600px;
      margin: auto;
      background: var(--bg);
      color: var(--fg);
      transition: background 0.3s, color 0.3s;
      position: relative;
    }
    :root {
      --bg: #ffffff;
      --fg: #000000;
      --input-bg: #f0f0f0;
      --input-fg: #000000;
      --border: #cccccc;
      --button-bg: #e0e0e0;
      --button-fg: #000000;
      --button-hover-bg: #d0d0d0;
      --overlay-bg: rgba(200, 200, 200, 0.5);
      --status-color: #666666;
    }
    [data-theme="dark"] {
      --bg: #121212;
      --fg: #e0e0e0;
      --input-bg: #1e1e1e;
      --input-fg: #e0e0e0;
      --border: #333333;
      --button-bg: #333333;
      --button-fg: #e0e0e0;
      --button-hover-bg: #444444;
      --overlay-bg: rgba(30, 30, 30, 0.5);
      --status-color: #aaaaaa;
    }
    input,
    textarea {
      background: var(--input-bg);
      color: var(--input-fg);
      border: 1px solid var(--border);
      padding: 0.25rem;
      border-radius: 4px;
      margin-top: 0.25rem;
    }
    input[type="number"] {
      width: 4rem;
      margin-right: 0.5rem;
    }
    textarea {
      width: 100%;
      height: 3rem;
      box-sizing: border-box;
    }
    button {
      margin: 0.25rem 0.25rem 0.5rem 0;
      background: var(--button-bg);
      color: var(--button-fg);
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.2s;
    }
    button:hover:not(:disabled) {
      background: var(--button-hover-bg);
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    #theme-toggle {
      position: fixed;
      top: 1rem;
      right: 1rem;
      padding: 0.25rem 0.5rem;
      font-size: 1rem;
      z-index: 10;
    }
    #day-navigation {
      margin-bottom: 1rem;
      text-align: center;
    }
    #day-label {
      margin: 0 1rem;
      font-weight: bold;
    }
    .set {
      margin-bottom: 0.75rem;
      border-left: 3px solid transparent;
      padding-left: 0.5rem;
    }
    .set.dirty {
      border-left-color: orange;
    }
    .set.saving {
      border-left-color: blue;
    }
    .set.saved {
      border-left-color: green;
    }
    #loading-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: var(--overlay-bg);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      z-index: 5;
    }
    .hidden {
      display: none;
    }
    #status-message {
      margin-top: 1rem;
      color: var(--status-color);
      min-height: 1.2em;
      text-align: center;
    }
    #error-message {
      color: red;
      margin-top: 1rem;
      text-align: center;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <button id="theme-toggle" aria-label="Toggle theme">üåô</button>
  <h1>üèãÔ∏è Workout Resistance Tracker</h1>

  <div id="loading-overlay" class="hidden">Loading...</div>
  <div id="error-message" class="hidden"></div>

  <div id="auth">
    <h2>Login</h2>
    <div>
      <input id="email" type="email" placeholder="Email" required />
    </div>
    <div>
      <input id="password" type="password" placeholder="Password" required />
    </div>
    <button id="login-btn">Login</button>
  </div>

  <div id="tracker" class="hidden">
    <div id="day-navigation">
      <button id="prev-btn">‚¨ÖÔ∏è Prev</button>
      <span id="day-label"></span>
      <button id="next-btn">Next ‚û°Ô∏è</button>
    </div>
    <div id="exercises"></div>
    <button id="logout-btn">Logout</button>
  </div>

  <script>
    // --- Configuration & State ---
    const SUPABASE_URL = 'https://dzqlnpyewelfkybzeylm.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...';
    const EXERCISES = ['GS', 'PU', 'DR', 'RD', 'PL'];
    const NUM_SETS = 3;
    const DAY_INCREMENT = 2; // every other day
    const TOTAL_WORKOUT_DAYS = 15;
    const MAX_DAY_INDEX = TOTAL_WORKOUT_DAYS - 1;
    const DEBOUNCE_MS = 1200;
    const WORKOUTS_TABLE = 'workouts';
    const THEME_KEY = 'tracker-theme';

    let currentDay = 0;
    let sessionStartDate = new Date();
    sessionStartDate.setHours(0, 0, 0, 0);
    let userId = null;
    let saveTimer = null;
    let isSaving = false;

    // Initialize Supabase client (global `supabase` from UMD)
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // --- DOM Elements ---
    let authDiv, trackerDiv;
    let emailInput, passwordInput, loginBtn;
    let prevBtn, nextBtn, logoutBtn, dayLabel;
    let exercisesDiv, themeToggle, errorDiv, loadingOverlay;

    // --- Utility Functions ---
    function showLoading(message = 'Loading...') {
      loadingOverlay.textContent = message;
      loadingOverlay.classList.remove('hidden');
    }
    function hideLoading() {
      loadingOverlay.classList.add('hidden');
    }
    function showError(message) {
      errorDiv.textContent = message;
      errorDiv.classList.remove('hidden');
      console.error(message);
    }
    function hideError() {
      errorDiv.classList.add('hidden');
    }

    function applyTheme(theme) {
      document.documentElement.setAttribute('data-theme', theme);
      localStorage.setItem(THEME_KEY, theme);
      themeToggle.textContent = theme === 'dark' ? 'üåû' : 'üåô';
    }
    function toggleTheme() {
      const current = document.documentElement.getAttribute('data-theme');
      applyTheme(current === 'dark' ? 'light' : 'dark');
    }

    function getDayISO(dayIndex) {
      const d = new Date(sessionStartDate);
      d.setDate(d.getDate() + dayIndex * DAY_INCREMENT);
      return d.toISOString().split('T')[0];
    }

    function updateDayNavigation() {
      dayLabel.textContent = `Day ${currentDay + 1} (${getDayISO(currentDay)})`;
      prevBtn.disabled = currentDay === 0 || isSaving;
      nextBtn.disabled = currentDay === MAX_DAY_INDEX || isSaving;
    }

    // --- Rendering Workouts ---
    async function renderUI() {
      showLoading('Loading day data...');
      hideError();
      exercisesDiv.innerHTML = '';
      updateDayNavigation();

      const date = getDayISO(currentDay);
      let sessionData;
      try {
        const response = await supabaseClient.auth.getSession();
        // Optional: use response data if needed
      } catch (err) {
        // Do nothing, renderUI focuses on workouts
      }

      let dataRows;
      try {
        const { data, error } = await supabaseClient
          .from(WORKOUTS_TABLE)
          .select('*')
          .eq('user_id', userId)
          .eq('date', date);
        if (error) throw error;
        dataRows = data || [];
      } catch (err) {
        showError('Failed to load workouts: ' + err.message);
        hideLoading();
        return;
      }

      // Map existing data
      const state = {};
      dataRows.forEach(row => {
        state[`${row.exercise_id}-${row.set_num}`] = row;
      });

      // Build UI
      EXERCISES.forEach(ex => {
        const section = document.createElement('div');
        section.dataset.exerciseId = ex;

        const header = document.createElement('h3');
        header.textContent = ex;
        section.appendChild(header);

        for (let setNum = 1; setNum <= NUM_SETS; setNum++) {
          const existing = state[`${ex}-${setNum}`] || {};
          const setDiv = document.createElement('div');
          setDiv.className = 'set';
          setDiv.dataset.setNum = setNum;

          const label = document.createTextNode(`Set ${setNum}: `);
          const repsInput = document.createElement('input');
          repsInput.type = 'number';
          repsInput.min = '0';
          repsInput.placeholder = 'Reps';
          repsInput.value = existing.reps || '';

          const weightInput = document.createElement('input');
          weightInput.type = 'number';
          weightInput.min = '0';
          weightInput.placeholder = 'Weight';
          weightInput.value = existing.weight || '';

          const notesArea = document.createElement('textarea');
          notesArea.placeholder = 'Notes (optional)';
          notesArea.value = existing.notes || '';

          [repsInput, weightInput, notesArea].forEach(el => {
            el.addEventListener('input', () => {
              setDiv.classList.remove('saved', 'saving');
              setDiv.classList.add('dirty');
              debounceSave();
            });
          });

          setDiv.append(label, repsInput, weightInput, notesArea);
          section.appendChild(setDiv);
        }

        exercisesDiv.appendChild(section);
      });

      hideLoading();
    }

    // --- Saving Workouts ---
    function debounceSave() {
      if (isSaving) return;
      clearTimeout(saveTimer);
      saveTimer = setTimeout(savePendingChanges, DEBOUNCE_MS);
    }

    async function savePendingChanges() {
      const date = getDayISO(currentDay);
      const dirtySets = document.querySelectorAll('.set.dirty');
      if (!dirtySets.length) return;

      isSaving = true;
      showLoading('Saving changes...');
      hideError();
      updateDayNavigation();

      const promises = [];
      dirtySets.forEach(setDiv => {
        setDiv.classList.remove('dirty');
        setDiv.classList.add('saving');
        const exercise_id = setDiv.closest('[data-exercise-id]').dataset.exerciseId;
        const set_num = parseInt(setDiv.dataset.setNum, 10);
        const inputs = setDiv.querySelectorAll('input[type="number"]');
        const notes = setDiv.querySelector('textarea').value.trim();
        const reps = parseInt(inputs[0].value, 10) || null;
        const weight = parseFloat(inputs[1].value) || null;

        promises.push(
          supabaseClient
            .from(WORKOUTS_TABLE)
            .upsert(
              {
                user_id: userId,
                date,
                exercise_id,
                set_num,
                reps,
                weight,
                notes: notes || null,
                updated_at: new Date().toISOString()
              },
              { onConflict: 'user_id,date,exercise_id,set_num' }
            )
            .then(({ error }) => {
              if (error) {
                setDiv.classList.remove('saving');
                setDiv.classList.add('dirty');
                throw error;
              } else {
                setDiv.classList.remove('saving');
                setDiv.classList.add('saved');
                setTimeout(() => setDiv.classList.remove('saved'), 2000);
              }
            })
        );
      });

      try {
        await Promise.all(promises);
      } catch (err) {
        showError('Error saving: ' + err.message);
      } finally {
        isSaving = false;
        hideLoading();
        updateDayNavigation();
      }
    }

    // --- Authentication Handlers ---
    async function handleLogin() {
      showLoading('Logging in...');
      hideError();
      loginBtn.disabled = true;
      try {
        const { data, error } = await supabaseClient.auth.signInWithPassword({
          email: emailInput.value,
          password: passwordInput.value
        });
        if (error) throw error;
        userId = data.session.user.id;
        authDiv.classList.add('hidden');
        trackerDiv.classList.remove('hidden');
        await renderUI();
      } catch (err) {
        showError('Login failed: ' + err.message);
      } finally {
        hideLoading();
        loginBtn.disabled = false;
      }
    }

    async function handleLogout() {
      showLoading('Logging out...');
      hideError();
      logoutBtn.disabled = true;
      clearTimeout(saveTimer);
      if (document.querySelectorAll('.set.dirty').length) {
        await savePendingChanges();
      }
      try {
        const { error } = await supabaseClient.auth.signOut();
        if (error) throw error;
        userId = null;
        currentDay = 0;
        trackerDiv.classList.add('hidden');
        authDiv.classList.remove('hidden');
        exercisesDiv.innerHTML = '';
        emailInput.value = '';
        passwordInput.value = '';
      } catch (err) {
        showError('Logout failed: ' + err.message);
      } finally {
        hideLoading();
        logoutBtn.disabled = false;
      }
    }

    // --- App Initialization ---
    async function initializeApp() {
      // Grab DOM elements
      authDiv = document.getElementById('auth');
      trackerDiv = document.getElementById('tracker');
      emailInput = document.getElementById('email');
      passwordInput = document.getElementById('password');
      loginBtn = document.getElementById('login-btn');
      prevBtn = document.getElementById('prev-btn');
      nextBtn = document.getElementById('next-btn');
      logoutBtn = document.getElementById('logout-btn');
      dayLabel = document.getElementById('day-label');
      exercisesDiv = document.getElementById('exercises');
      themeToggle = document.getElementById('theme-toggle');
      errorDiv = document.getElementById('error-message');
      loadingOverlay = document.getElementById('loading-overlay');

      // Theme setup
      const savedTheme = localStorage.getItem(THEME_KEY) ||
        (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
      applyTheme(savedTheme);
      themeToggle.addEventListener('click', toggleTheme);

      // Auth button bindings
      loginBtn.addEventListener('click', handleLogin);
      logoutBtn.addEventListener('click', handleLogout);

      // Navigation
      prevBtn.addEventListener('click', () => {
        if (currentDay > 0 && !isSaving) {
          clearTimeout(saveTimer);
          currentDay--;
          renderUI();
        }
      });
      nextBtn.addEventListener('click', () => {
        if (currentDay < MAX_DAY_INDEX && !isSaving) {
          clearTimeout(saveTimer);
          currentDay++;
          renderUI();
        }
      });

      // Enter key for login
      passwordInput.addEventListener('keypress', e => {
        if (e.key === 'Enter') handleLogin();
      });

      // Initial session check
      showLoading('Checking session...');
      hideError();
      try {
        const { data, error } = await supabaseClient.auth.getSession();
        if (error) throw error;
        const session = data.session;
        if (session) {
          userId = session.user.id;
          authDiv.classList.add('hidden');
          trackerDiv.classList.remove('hidden');
          await renderUI();
        } else {
          authDiv.classList.remove('hidden');
          trackerDiv.classList.add('hidden');
        }
      } catch (err) {
        showError('Session error: ' + err.message);
        authDiv.classList.remove('hidden');
      } finally {
        hideLoading();
      }
    }

    // Boot
    window.addEventListener('DOMContentLoaded', initializeApp);
  </script>
</body>
</html>
