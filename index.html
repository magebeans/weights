<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Workout Tracker</title>

  <!-- Load config.js for Supabase credentials -->
  <script type="module">
  import { SUPABASE_URL, SUPABASE_ANON_KEY } from './config.js';

  window.SUPABASE_URL = SUPABASE_URL;
  window.SUPABASE_ANON_KEY = SUPABASE_ANON_KEY;

  // Then continue initializing the rest...
  </script>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
    if (!window.SUPABASE_URL || !window.SUPABASE_ANON_KEY) {
      const banner = document.createElement('div');
      banner.className = 'banner show';
      banner.textContent = 'Missing config: define SUPABASE_URL and SUPABASE_ANON_KEY in config.js';
      document.body.appendChild(banner);
      throw new Error('Missing Supabase config');
    }
   });
  </script>

  <!-- Supabase client (UMD) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>

  <style>
    :root[data-theme='light'] {
      --bg: #ffffff;
      --fg: #000000;
      --input-bg: #ffffff;
      --input-fg: #000000;
      --header-bg: #f0f0f0;
    }
    :root[data-theme='dark'] {
      --bg: #000000;
      --fg: #ffffff;
      --input-bg: #222222;
      --input-fg: #ffffff;
      --header-bg: #333333;
    }
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
    }
    body {
      background: var(--bg);
      color: var(--fg);
      font-family: sans-serif;
      margin: 0 auto;
      padding: 1rem;
      max-width: 600px;
      position: relative;
      min-height: 100vh;
    }
    .hidden {
      display: none;
    }
    .overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 0, 0, 0.7);
      color: #fff;
      align-items: center;
      justify-content: center;
      text-align: center;
      font-size: 1.25rem;
      z-index: 1000;
      padding: 1rem;
    }
    .overlay.show {
      display: flex;
    }
    .banner {
      display: none;
      background: #e74c3c;
      color: #fff;
      padding: 0.5rem;
      margin-bottom: 1rem;
    }
    .banner.show {
      display: flex;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: var(--header-bg);
      padding: 0.75rem 1rem;
      margin-bottom: 2rem;
      border-radius: 0.75rem;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
    }
    header button {
      background: none;
      border: 1px solid var(--fg);
      color: var(--fg);
      padding: 0.4rem 0.75rem;
      border-radius: 0.5rem;
      font-size: 1rem;
      cursor: pointer;
    }
    header button:hover {
      background: rgba(255, 255, 255, 0.05);
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    #workout-form .exercise-block {
      margin-bottom: 1.5rem;
    }
    #workout-form .exercise-title {
      font-weight: bold;
      margin-bottom: 0.5rem;
    }
    #workout-form .set-row {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }
    input,
    textarea {
      background: var(--input-bg);
      color: var(--input-fg);
      border: 1px solid #ccc;
      padding: 0 0.5rem;
      font-size: 0.9rem;
      border-radius: 0.5rem;
      transition: background-color 0.3s ease;
      height: 2rem;
      line-height: 2rem;
    }
    input.filled,
    textarea.filled {
      background-color: rgba(135, 206, 250, 0.2);
    }
    input.dirty,
    textarea.dirty {
      border-color: orange;
    }
    input.saving,
    textarea.saving {
      border-color: blue;
    }
    input.saved,
    textarea.saved {
      border-color: green;
    }
    textarea {
      resize: none;
    }
    @media (max-width: 600px) {
      input,
      textarea {
        font-size: 0.9rem;
      }
    }
  </style>
</head>

<body>
  <div id="overlay" class="overlay">Checking session...</div>
  <div id="banner" class="banner"></div>
  <div id="auth-ui" class="hidden">
    <form id="login-form">
      <input type="email" id="email" placeholder="Email" required />
      <input type="password" id="password" placeholder="Password" required />
      <button type="submit">Login</button>
    </form>
  </div>
  <div id="tracker-ui" class="hidden">
    <header>
      <button id="prev-day">Prev</button>
      <span id="day-label"></span>
      <button id="next-day">Next</button>
      <button id="theme-toggle">ðŸŒ™</button>
      <button id="logout">Logout</button>
    </header>
    <form id="workout-form"></form>
  </div>

  <script>
    const overlay       = document.getElementById('overlay');
    const banner        = document.getElementById('banner');
    const authUI        = document.getElementById('auth-ui');
    const trackerUI     = document.getElementById('tracker-ui');
    const emailInput    = document.getElementById('email');
    const passwordInput = document.getElementById('password');
    const prevDay       = document.getElementById('prev-day');
    const nextDay       = document.getElementById('next-day');
    const dayLabel      = document.getElementById('day-label');
    const workoutForm   = document.getElementById('workout-form');

    const SUPABASE_URL      = window.SUPABASE_URL;
    const SUPABASE_ANON_KEY = window.SUPABASE_ANON_KEY;
    const supabaseClient   = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const exMap = { GS:'Goblet Squat', PU:'Push-Up', DR:'Deadlift', RD:'Row', PL:'Plank' };
    let currentDate = new Date().toISOString().slice(0, 10), savesInProgress = 0;
    const saveTimers = {};

    document.addEventListener('DOMContentLoaded', () => { applyTheme(); bindListeners(); initSession(); });

    function bindListeners() {
      document.getElementById('login-form').addEventListener('submit', login);
      document.getElementById('logout').addEventListener('click', logout);
      prevDay.addEventListener('click', () => navigateDays(-1));
      nextDay.addEventListener('click', () => navigateDays(1));
      document.getElementById('theme-toggle').addEventListener('click', toggleTheme);
    }

    async function initSession() {
      showOverlay('Checking session...');
      const { data:{ session }, error } = await supabaseClient.auth.getSession(); hideOverlay();
      if (error) { showBanner(error.message); showAuthUI(); return; }
      if (!session) { showAuthUI(); return; }
      window.user = session.user; showTrackerUI(); renderDay(currentDate);
    }

    async function login(e) { e.preventDefault(); showOverlay('Logging in...'); const { error } = await supabaseClient.auth.signInWithPassword({ email: emailInput.value, password: passwordInput.value }); hideOverlay(); if (error) { showBanner(error.message); return; } initSession(); }
    async function logout() { await supabaseClient.auth.signOut(); window.user=null; currentDate = new Date().toISOString().slice(0, 10); showAuthUI(); }
    function showAuthUI()    { authUI.classList.remove('hidden'); trackerUI.classList.add('hidden'); }
    function showTrackerUI() { authUI.classList.add('hidden'); trackerUI.classList.remove('hidden'); }

    function formatDateLabel(dateStr) {
      const d = new Date(dateStr);
      return d.toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric', weekday: 'short' });
    }

    async function renderDay(dateStr) {
      showOverlay('Loading...'); hideBanner();
      currentDate = dateStr;
      dayLabel.textContent = formatDateLabel(dateStr);
      disableNav(true);
      const { data, error } = await supabaseClient.from('workouts').select('*').eq('user_id', window.user.id).eq('date', dateStr);
      if (error) showBanner(error.message);
      workoutForm.innerHTML = '';
      ['GS','PU','DR','RD','PL'].forEach(ex => {
        const block = document.createElement('div'); block.classList.add('exercise-block');
        const title = document.createElement('div'); title.classList.add('exercise-title'); title.textContent = exMap[ex] || ex; block.appendChild(title);
        for (let s = 1; s <= 3; s++) {
          const rec = data?.find(r => r.exercise_id === ex && r.set_num === s) || {};
          const row = document.createElement('div'); row.classList.add('set-row');
          ['reps','notes'].forEach(field => {
            const el = field === 'notes' ? document.createElement('textarea') : document.createElement('input');
            if (field !== 'notes') { el.type = 'number'; el.placeholder = field.charAt(0).toUpperCase() + field.slice(1); }
            else { el.placeholder = 'Notes'; }
            el.value = rec[field] || '';
            if (el.value) el.classList.add('filled');
            el.dataset.exercise = ex; el.dataset.set = s; el.dataset.field = field;
            el.addEventListener('input', onInput);
            row.appendChild(el);
          });
          if (!['PU', 'PL'].includes(ex)) {
            const wtEl = document.createElement('input');
            wtEl.type = 'number';
            wtEl.placeholder = 'Weight';
            wtEl.value = rec['weight'] || '';
            if (wtEl.value) wtEl.classList.add('filled');
            wtEl.dataset.exercise = ex; wtEl.dataset.set = s; wtEl.dataset.field = 'weight';
            wtEl.addEventListener('input', onInput);
            row.insertBefore(wtEl, row.children[1]);
          }
          block.appendChild(row);
        }
        workoutForm.appendChild(block);
      });
      disableNav(false);
      hideOverlay();
    }

    function navigateDays(offset) {
      const d = new Date(currentDate);
      d.setDate(d.getDate() + offset);
      renderDay(d.toISOString().slice(0, 10));
    }

    function onInput(e) {
      if (savesInProgress > 0) return;
      const el = e.target;
      if (el.value) el.classList.add('filled'); else el.classList.remove('filled');
      markDirty(el);
      const key = `${el.dataset.exercise}-${el.dataset.set}`;
      clearTimeout(saveTimers[key]);
      saveTimers[key] = setTimeout(() => saveSet(el.dataset.exercise, el.dataset.set), 1200);
    }

    async function saveSet(ex, s) {
      savesInProgress++; updateSavingState();
      const repsEl = document.querySelector(`input[data-exercise="${ex}"][data-set="${s}"][data-field="reps"]`);
      const wtEl = document.querySelector(`input[data-exercise="${ex}"][data-set="${s}"][data-field="weight"]`);
      const notesEl = document.querySelector(`textarea[data-exercise="${ex}"][data-set="${s}"][data-field="notes"]`);
      const payload = {
        date: currentDate,
        exercise_id: ex,
        set_num: s,
        reps: repsEl.value ? parseInt(repsEl.value) : null,
        weight: wtEl ? (wtEl.value ? parseFloat(wtEl.value) : null) : null,
        notes: notesEl.value || null
      };
      markSaving(ex, s);
      const { error } = await supabaseClient.from('workouts').upsert(payload, { onConflict: ['user_id','date','exercise_id','set_num'] });
      if (error) { showBanner(`Save failed: ${error.message}`); markError(ex, s); } else { markSaved(ex, s); }
      savesInProgress--; updateSavingState();
    }

    function markDirty(el) { el.classList.remove('saving','saved'); el.classList.add('dirty'); }
    function markSaving(ex,s) { document.querySelectorAll(`[data-exercise="${ex}"][data-set="${s}"]`).forEach(el=>{ el.classList.remove('dirty','saved'); el.classList.add('saving'); }); }
    function markSaved(ex,s) { document.querySelectorAll(`[data-exercise="${ex}"][data-set="${s}"]`).forEach(el=>{ el.classList.remove('dirty','saving'); el.classList.add('saved'); }); }
    function markError(ex,s) { document.querySelectorAll(`[data-exercise="${ex}"][data-set="${s}"]`).forEach(el=>{ el.classList.remove('saving','saved'); el.classList.add('dirty'); }); }

    function updateSavingState() { const busy = savesInProgress > 0; disableNav(busy); document.querySelectorAll('#workout-form input,#workout-form textarea').forEach(el => el.disabled = busy); if (busy) showOverlay('Saving...'); else hideOverlay(); }
    function disableNav(val) { prevDay.disabled = val; nextDay.disabled = val; }
    function showOverlay(msg) { overlay.textContent = msg; overlay.classList.add('show'); }
    function hideOverlay() { overlay.classList.remove('show'); }
    function showBanner(msg) { banner.textContent = msg; banner.classList.add('show'); }
    function hideBanner() { banner.classList.remove('show'); }
    function applyTheme() { const saved = localStorage.getItem('tracker-theme'); const sys = window.matchMedia('(prefers-color-scheme:dark)').matches ? 'dark' : 'light'; document.documentElement.setAttribute('data-theme', saved || sys); }
    function toggleTheme() { const curr = document.documentElement.getAttribute('data-theme'); const next = curr === 'dark' ? 'light' : 'dark'; localStorage.setItem('tracker-theme', next); applyTheme(); }
  </script>
</body>

</html>
