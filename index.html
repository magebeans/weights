<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Workout Resistance Tracker</title>
  <!-- Supabase UMD build -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <style>
    /* Base & Theming */
    body { font-family: sans-serif; padding: 1rem; max-width: 600px; margin: auto; background: var(--bg); color: var(--fg); transition: background .3s, color .3s; position: relative; }
    :root { --bg: #fff; --fg: #000; --input-bg: #f0f0f0; --input-fg: #000; --border: #ccc; --button-bg: #e0e0e0; --button-fg: #000; --button-hover-bg: #d0d0d0; --overlay-bg: rgba(200,200,200,0.5); --status-color: #666; }
    [data-theme="dark"] { --bg:#121212; --fg:#e0e0e0; --input-bg:#1e1e1e; --input-fg:#e0e0e0; --border:#333; --button-bg:#333; --button-fg:#e0e0e0; --button-hover-bg:#444; --overlay-bg:rgba(30,30,30,0.5); --status-color:#aaa; }
    input,textarea { background:var(--input-bg); color:var(--input-fg); border:1px solid var(--border); padding:.25rem; border-radius:4px; margin-top:.25rem; }
    input[type=number] { width:4rem; margin-right:.5rem; }
    textarea { width:100%; height:3rem; box-sizing:border-box; }
    button { margin:.25rem .25rem .5rem 0; background:var(--button-bg); color:var(--button-fg); border:none; padding:.5rem 1rem; border-radius:4px; cursor:pointer; transition:background .2s; }
    button:hover:not(:disabled){ background:var(--button-hover-bg); }
    button:disabled{ opacity:.5; cursor:not-allowed; }
    #theme-toggle{ position:fixed; top:1rem; right:1rem; padding:.25rem .5rem; font-size:1rem; z-index:10; }
    #day-navigation{ margin-bottom:1rem; text-align:center; }
    #day-label{ margin:0 1rem; font-weight:bold; }
    .set{ margin-bottom:.75rem; border-left:3px solid transparent; padding-left:.5rem; }
    .set.dirty{ border-color:orange; }
    .set.saving{ border-color:blue; }
    .set.saved{ border-color:green; }
    #loading-overlay{ position:absolute; top:0; left:0; width:100%; height:100%; background:var(--overlay-bg); display:flex; align-items:center; justify-content:center; font-size:1.2rem; z-index:5; }
    .hidden{ display:none; }
    #status-message{ margin-top:1rem; color:var(--status-color); min-height:1.2em; text-align:center; }
    #error-message{ color:red; margin-top:1rem; text-align:center; font-weight:bold; }
  </style>
</head>
<body>
  <button id="theme-toggle" aria-label="Toggle theme"></button>
  <h1>üèãÔ∏è Workout Resistance Tracker</h1>
  <div id="loading-overlay" class="hidden">Loading...</div>
  <div id="error-message" class="hidden"></div>

  <div id="auth">
    <h2>Login</h2>
    <input id="email" type="email" placeholder="Email" required />
    <input id="password" type="password" placeholder="Password" required />
    <button id="login-btn">Login</button>
  </div>

  <div id="tracker" class="hidden">
    <div id="day-navigation">
      <button id="prev-btn">‚¨ÖÔ∏è Prev</button>
      <span id="day-label"></span>
      <button id="next-btn">Next ‚û°Ô∏è</button>
    </div>
    <div id="exercises"></div>
    <button id="logout-btn">Logout</button>
  </div>

  <script>
    // Constants
    const SUPABASE_URL='https://dzqlnpyewelfkybzeylm.supabase.co', SUPABASE_ANON_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...', EXERCISES=['GS','PU','DR','RD','PL'], NUM_SETS=3, DAY_INCREMENT=2, TOTAL_WORKOUT_DAYS=15, MAX_DAY_INDEX=TOTAL_WORKOUT_DAYS-1, DEBOUNCE_MS=1200, WORKOUTS_TABLE='workouts', THEME_KEY='tracker-theme';
    let currentDay=0, sessionStartDate=new Date(), userId=null, saveTimer=null, isSaving=false;
    sessionStartDate.setHours(0,0,0,0);
    const supabaseClient=supabase.createClient(SUPABASE_URL,SUPABASE_ANON_KEY);
    // DOM refs
    let authDiv,trackerDiv,emailInput,passwordInput,loginBtn,prevBtn,nextBtn,logoutBtn,dayLabel,exercisesDiv,themeToggle,errorDiv,loadingOverlay;
    // Helpers
    const showLoading=msg=>{loadingOverlay.textContent=msg;loadingOverlay.classList.remove('hidden');}, hideLoading=()=>loadingOverlay.classList.add('hidden');
    const showError=msg=>{errorDiv.textContent=msg;errorDiv.classList.remove('hidden');console.error(msg);}, hideError=()=>errorDiv.classList.add('hidden');
    const applyTheme=theme=>{document.documentElement.setAttribute('data-theme',theme);localStorage.setItem(THEME_KEY,theme);themeToggle.textContent=theme==='dark'?'üåû':'üåô';};
    const toggleTheme=()=>applyTheme(document.documentElement.getAttribute('data-theme')==='dark'?'light':'dark');
    const getDayISO=idx=>{const d=new Date(sessionStartDate);d.setDate(d.getDate()+idx*DAY_INCREMENT);return d.toISOString().split('T')[0];};
    const updateDayNav=()=>{dayLabel.textContent=`Day ${currentDay+1} (${getDayISO(currentDay)})`;prevBtn.disabled=currentDay===0||isSaving;nextBtn.disabled=currentDay===MAX_DAY_INDEX||isSaving;};
    // Render
    async function renderUI(){showLoading('Loading...');hideError();exercisesDiv.innerHTML='';updateDayNav();const date=getDayISO(currentDay);
      let data;
      try{({data,error}=await supabaseClient.from(WORKOUTS_TABLE).select('*').eq('user_id',userId).eq('date',date));if(error)throw error;}catch(e){showError('Load error: '+e.message);hideLoading();return;}const state={};data.forEach(r=>state[`${r.exercise_id}-${r.set_num}`]=r);
      EXERCISES.forEach(ex=>{const sec=document.createElement('div');sec.dataset.exerciseId=ex;const h3=document.createElement('h3');h3.textContent=ex;sec.appendChild(h3);
        for(let s=1;s<=NUM_SETS;s++){const row=state[`${ex}-${s}`]||{};const div=document.createElement('div');div.className='set';div.dataset.setNum=s;const lbl=document.createTextNode(`Set ${s}: `);
          const ri=document.createElement('input');ri.type='number';ri.min=0;ri.placeholder='Reps';ri.value=row.reps||'';
          const wi=document.createElement('input');wi.type='number';wi.min=0;wi.placeholder='Weight';wi.value=row.weight||'';
          const na=document.createElement('textarea');na.placeholder='Notes(optional)';na.value=row.notes||'';
          [ri,wi,na].forEach(el=>el.addEventListener('input',()=>{div.classList.remove('saved','saving');div.classList.add('dirty');debounceSave();}));
          div.append(lbl,ri,wi,na);sec.appendChild(div);}exercisesDiv.appendChild(sec);});hideLoading();}
    // Save
    function debounceSave(){if(isSaving)return;clearTimeout(saveTimer);saveTimer=setTimeout(saveChanges,DEBOUNCE_MS);}    
    async function saveChanges(){if(isSaving)return;const date=getDayISO(currentDay);const dirty=document.querySelectorAll('.set.dirty');if(!dirty.length)return;isSaving=true;showLoading('Saving...');hideError();updateDayNav();
      const promises=[];dirty.forEach(div=>{div.classList.remove('dirty');div.classList.add('saving');const ex=div.dataset.exerciseId;const s=parseInt(div.dataset.setNum);const [ri,wi]=div.querySelectorAll('input');const notes=div.querySelector('textarea').value.trim();const reps=parseInt(ri.value)||null;const weight=parseFloat(wi.value)||null;
        promises.push(supabaseClient.from(WORKOUTS_TABLE).upsert({user_id:userId,date,exercise_id:ex,set_num:s,reps,weight,notes:notes||null},{onConflict:'user_id,date,exercise_id,set_num'}).then(({error})=>{if(error){div.classList.remove('saving');div.classList.add('dirty');throw error;}else{div.classList.remove('saving');div.classList.add('saved');setTimeout(()=>div.classList.remove('saved'),2000);}}));});
      try{await Promise.all(promises);}catch(e){showError('Save error: '+e.message);}finally{isSaving=false;hideLoading();updateDayNav();}}
    // Auth
    async function handleLogin(){showLoading('Logging in...');hideError();loginBtn.disabled=true;try{const { data,error }=await supabaseClient.auth.signInWithPassword({email:emailInput.value,password:passwordInput.value});if(error)throw error;userId=data.session.user.id;authDiv.classList.add('hidden');trackerDiv.classList.remove('hidden');await renderUI();}catch(e){showError('Login failed: '+e.message);}finally{hideLoading();loginBtn.disabled=false;}}
    async function handleLogout(){showLoading('Logging out...');hideError();logoutBtn.disabled=true;clearTimeout(saveTimer);if(document.querySelectorAll('.set.dirty').length)await saveChanges();try{const { error }=await supabaseClient.auth.signOut();if(error)throw error;userId=null;currentDay=0;trackerDiv.classList.add('hidden');authDiv.classList.remove('hidden');exercisesDiv.innerHTML='';emailInput.value='';passwordInput.value='';}catch(e){showError('Logout failed: '+e.message);}finally{hideLoading();logoutBtn.disabled=false;}}
    // Init
    async function initializeApp(){authDiv=document.getElementById('auth');trackerDiv=document.getElementById('tracker');emailInput=document.getElementById('email');passwordInput=document.getElementById('password');loginBtn=document.getElementById('login-btn');prevBtn=document.getElementById('prev-btn');nextBtn=document.getElementById('next-btn');logoutBtn=document.getElementById('logout-btn');dayLabel=document.getElementById('day-label');exercisesDiv=document.getElementById('exercises');themeToggle=document.getElementById('theme-toggle');errorDiv=document.getElementById('error-message');loadingOverlay=document.getElementById('loading-overlay');
      const saved=localStorage.getItem(THEME_KEY)||(window.matchMedia('(prefers-color-scheme: dark)').matches?'dark':'light');applyTheme(saved);themeToggle.addEventListener('click',toggleTheme);loginBtn.addEventListener('click',handleLogin);logoutBtn.addEventListener('click',handleLogout);passwordInput.addEventListener('keypress',e=>{if(e.key==='Enter')handleLogin();});prevBtn.addEventListener('click',()=>{if(currentDay>0&&!isSaving){clearTimeout(saveTimer);currentDay--;renderUI();}});nextBtn.addEventListener('click',()=>{if(currentDay<MAX_DAY_INDEX&&!isSaving){clearTimeout(saveTimer);currentDay++;renderUI();}});
      showLoading('Checking session...');hideError();
      try{const { data:{session},error }=await supabaseClient.auth.getSession();if(error)throw error; if(session){userId=session.user.id;authDiv.classList.add('hidden');trackerDiv.classList.remove('hidden');await renderUI();}else{authDiv.classList.remove('hidden');trackerDiv.classList.add('hidden');hideLoading();}}catch(e){showError('Session error: '+e.message);authDiv.classList.remove('hidden');hideLoading();}}
    window.addEventListener('DOMContentLoaded',initializeApp);
  </script>
</body>
</html>
